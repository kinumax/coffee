<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PeerJS WebRTC Room App</title>
    <meta name="description" content="PeerJS WebRTC App with room management.">

    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“</text></svg>">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <style>
        body {
            font-family: sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        #localAudio, #remoteAudio {
            display: none;
        }
        .peer-id-box {
            font-family: 'Courier New', monospace;
            letter-spacing: 1px;
            cursor: copy;
        }
        .recording-pulse {
            animation: pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .connection-status-message {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen">
    <div id="app" class="container bg-white">
        <h1 class="text-3xl font-bold text-center text-blue-700 mb-6 flex items-center justify-center space-x-2">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            PeerJS éŸ³å£°é€šè©±ãƒ«ãƒ¼ãƒ ã‚¢ãƒ—ãƒª
        </h1>

        <div id="connectionStatus" class="connection-status-message p-3 mb-4 rounded-lg text-sm flex items-center space-x-2">
            <svg id="statusIcon" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <p id="statusText">æœªæ¥ç¶š</p>
        </div>

        <div class="space-y-6">
            <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg shadow-sm text-center hidden">
                <p class="text-blue-700 text-sm mb-2">ã‚ãªãŸã®Peer ID:</p>
                <div class="flex items-center justify-center space-x-2">
                    <span id="myPeerId" class="peer-id-box bg-blue-100 text-blue-800 px-4 py-2 rounded-md text-lg font-semibold select-all" onclick="copyToClipboard(this.textContent)">IDç”Ÿæˆä¸­...</span>
                    <button id="copyIdButton" class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-full shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                    </button>
                </div>
                <p class="text-gray-600 text-xs mt-2">ã“ã®IDã¯é–‹ç™ºç”¨ã§ã™ã€‚</p>
            </div>

            <div id="roomCreationSection" class="bg-indigo-50 border border-indigo-200 p-4 rounded-lg shadow-sm">
                <h2 class="text-xl font-bold text-indigo-700 mb-4 text-center">æ–°ã—ã„ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ</h2>
                <div class="flex flex-col space-y-3">
                    <input type="text" id="roomNameInput" placeholder="ãƒ«ãƒ¼ãƒ åã‚’å…¥åŠ› (ä¾‹: é›‘è«‡ãƒ«ãƒ¼ãƒ )" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-base">
                    <button id="createRoomButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors flex items-center justify-center space-x-2 text-lg">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        <span>ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆã—ã¦ãƒ›ã‚¹ãƒˆã«ãªã‚‹</span>
                    </button>
                </div>
            </div>

            <div id="roomListSection" class="bg-white border border-gray-200 p-4 rounded-lg shadow-sm">
                <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">å‚åŠ å¯èƒ½ãªãƒ«ãƒ¼ãƒ </h2>
                <div id="roomsContainer" class="min-h-[100px] max-h-60 overflow-y-auto border border-gray-300 p-3 rounded-lg bg-gray-50 space-y-2">
                    <p class="text-gray-600 text-center">ãƒ«ãƒ¼ãƒ ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                    </div>
                <button id="refreshRoomsButton" class="mt-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-gray-400 transition-colors w-full">
                    <svg class="inline-block w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004 12V8m5.414-1.586a1 1 0 010-1.414l-2-2a1 1 0 01-1.414 0L4 4m7 7l-2-2m2 2l-2 2"/></svg>
                    <span>ãƒ«ãƒ¼ãƒ ä¸€è¦§ã‚’æ›´æ–°</span>
                </button>
            </div>

            <div id="callControls" class="bg-gray-50 border border-gray-200 p-4 rounded-lg shadow-sm text-center hidden">
                <p class="text-gray-700 text-sm mb-2" id="callStatusText"></p>
                <div class="flex items-center justify-center space-x-4 mb-4">
                    <div id="recordingPulse" class="w-4 h-4 bg-red-500 rounded-full recording-pulse hidden"></div>
                    <div class="text-4xl font-bold text-gray-900" id="recordingTime">0:00</div>
                </div>
                <button id="endCallButton" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-red-500 transition-all flex items-center justify-center space-x-2 text-lg w-full">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16.72 11.06A10.94 10.94 0 0119 12.55a1 1 0 01-.051 1.81l-4.494 1.498a1 1 0 01-1.21-.502l-1.13-2.257M16.72 11.06l-1.475 1.475M16.72 11.06L21 6.78m-4.28 4.28L12 6.34m3.72 4.72l-3.72-4.72m0 0L5.78 1.22 4.36 2.64l14.142 14.142 1.415-1.414L11.06 6.34z"/></svg>
                    <span>é€šè©±ã‚’çµ‚äº†</span>
                </button>
            </div>

            <div class="bg-white border border-gray-200 p-4 rounded-lg shadow-sm">
                <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">ãƒãƒ£ãƒƒãƒˆ</h2>
                <div id="messages" class="h-60 overflow-y-auto border border-gray-300 p-3 rounded-lg bg-gray-50 mb-4 text-gray-700 text-sm leading-relaxed">
                    </div>
                <div class="flex space-x-2">
                    <input type="text" id="messageInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-base">
                    <button id="sendMessageButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                        é€ä¿¡
                    </button>
                </div>
            </div>
        </div>

        <audio id="localAudio" autoplay muted></audio>
        <audio id="remoteAudio" autoplay></audio>
    </div>

    <script>
        // DOMè¦ç´ ã®å–å¾—
        const myPeerIdEl = document.getElementById('myPeerId');
        const copyIdButton = document.getElementById('copyIdButton'); // ãƒ‡ãƒãƒƒã‚°ç”¨
        const roomNameInput = document.getElementById('roomNameInput');
        const createRoomButton = document.getElementById('createRoomButton');
        const roomsContainer = document.getElementById('roomsContainer');
        const refreshRoomsButton = document.getElementById('refreshRoomsButton');
        const callControls = document.getElementById('callControls');
        const endCallButton = document.getElementById('endCallButton');
        const localAudio = document.getElementById('localAudio');
        const remoteAudio = document.getElementById('remoteAudio');
        const messageInput = document.getElementById('messageInput');
        const sendMessageButton = document.getElementById('sendMessageButton');
        const messagesDiv = document.getElementById('messages');
        const recordingTimeEl = document.getElementById('recordingTime');
        const recordingPulseEl = document.getElementById('recordingPulse');
        const connectionStatusDiv = document.getElementById('connectionStatus');
        const statusIcon = document.getElementById('statusIcon');
        const statusText = document.getElementById('statusText');
        const callStatusText = document.getElementById('callStatusText');
        const roomCreationSection = document.getElementById('roomCreationSection');
        const roomListSection = document.getElementById('roomListSection');


        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹
        const AppState = {
            peer: null,
            myPeerId: null,
            audioStream: null,
            currentCall: null,
            dataConnection: null,
            isConnected: false, // PeerJSæ¥ç¶šãŒç¢ºç«‹ã—ã¦ã„ã‚‹ã‹
            isHost: false, // ãƒ›ã‚¹ãƒˆã¨ã—ã¦ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆã—ãŸã‹
            remotePeerId: null, // æ¥ç¶šç›¸æ‰‹ã®Peer ID
            currentRoomId: null, // ç¾åœ¨å‚åŠ ã—ã¦ã„ã‚‹ãƒ«ãƒ¼ãƒ ã®ID
            recordingTime: 0,
            recordingTimer: null,
            connectionStatus: 'disconnected', // disconnected, connecting, connected, error
            
            // ãƒ«ãƒ¼ãƒ ç®¡ç†APIã‚µãƒ¼ãƒãƒ¼ã®URLã‚’Vercel Functionsç”¨ã«å¤‰æ›´
            // Vercelã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã¨ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨åŒã˜ãƒ‰ãƒ¡ã‚¤ãƒ³ã® /api ãƒ‘ã‚¹ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™
            apiBaseUrl: '/api',

            // PeerJSã‚·ã‚°ãƒŠãƒªãƒ³ã‚°ã‚µãƒ¼ãƒãƒ¼ã®è¨­å®š
            peerServerConfig: {
                host: 'peerjs.live', // PeerJS Cloudã‚µãƒ¼ãƒ“ã‚¹ã®å ´åˆ
                port: 443, // HTTPSã®æ¨™æº–ãƒãƒ¼ãƒˆ
                path: '/myapp', // PeerJS Cloudã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ã‚¹ã€ã¾ãŸã¯ã‚ãªãŸã®ã‚«ã‚¹ã‚¿ãƒ ã‚µãƒ¼ãƒãƒ¼ã®ãƒ‘ã‚¹
                secure: true, // HTTPSçµŒç”±ã§æ¥ç¶šã™ã‚‹ãŸã‚ã€trueã‚’è¨­å®š
                config: {
                    'iceServers': [
                        { 'urls': 'stun:stun.l.google.com:19302' } // NATè¶Šãˆã®ãŸã‚ã®STUNã‚µãƒ¼ãƒãƒ¼
                    ]
                }
            }
        };

        // UIæ›´æ–°é–¢æ•°
        function updateUI() {
            myPeerIdEl.textContent = AppState.myPeerId || 'IDç”Ÿæˆä¸­...'; // ãƒ‡ãƒãƒƒã‚°ç”¨

            createRoomButton.disabled = AppState.isConnected || AppState.connectionStatus === 'connecting';
            roomNameInput.disabled = AppState.isConnected || AppState.connectionStatus === 'connecting';
            
            sendMessageButton.disabled = !AppState.isConnected || !AppState.dataConnection || !AppState.dataConnection.open;
            messageInput.disabled = !AppState.isConnected || !AppState.dataConnection || !AppState.dataConnection.open;
            
            // ãƒ«ãƒ¼ãƒ ä½œæˆãƒ»ä¸€è¦§è¡¨ç¤ºã‚¨ãƒªã‚¢ã®è¡¨ç¤ºåˆ¶å¾¡
            if (AppState.isConnected) { // é€šè©±ä¸­ã¯éš ã™
                roomCreationSection.classList.add('hidden');
                roomListSection.classList.add('hidden');
                callControls.classList.remove('hidden');
            } else { // é€šè©±ä¸­ã§ãªã‘ã‚Œã°è¡¨ç¤º
                roomCreationSection.classList.remove('hidden');
                roomListSection.classList.remove('hidden');
                callControls.classList.add('hidden');
            }


            // é€šè©±ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
            if (AppState.isConnected) {
                if (AppState.isHost) {
                    callStatusText.textContent = `ãƒ›ã‚¹ãƒˆã¨ã—ã¦ '${AppState.remotePeerId}' ã¨é€šè©±ä¸­`;
                    recordingPulseEl.classList.remove('hidden');
                } else {
                    callStatusText.textContent = `'${AppState.remotePeerId}' ã¨é€šè©±ä¸­`;
                    recordingPulseEl.classList.add('hidden');
                }
            } else {
                recordingPulseEl.classList.add('hidden');
            }

            // æ¥ç¶šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®è¡¨ç¤ºæ›´æ–°
            connectionStatusDiv.className = 'connection-status-message p-3 mb-4 rounded-lg text-sm flex items-center space-x-2';
            switch (AppState.connectionStatus) {
                case 'disconnected':
                    connectionStatusDiv.classList.add('bg-blue-50', 'border-blue-200', 'text-blue-800');
                    statusIcon.innerHTML = `<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                    statusText.textContent = 'æœªæ¥ç¶š';
                    break;
                case 'connecting':
                    connectionStatusDiv.classList.add('bg-yellow-50', 'border-yellow-200', 'text-yellow-800');
                    statusIcon.innerHTML = `<svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
                    statusText.textContent = 'æ¥ç¶šä¸­...';
                    break;
                case 'connected':
                    connectionStatusDiv.classList.add('bg-green-50', 'border-green-200', 'text-green-800');
                    statusIcon.innerHTML = `<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>`;
                    statusText.textContent = `æ¥ç¶šæ¸ˆã¿${AppState.remotePeerId ? `: ${AppState.remotePeerId}` : ''}`;
                    break;
                case 'error':
                    connectionStatusDiv.classList.add('bg-red-50', 'border-red-200', 'text-red-800');
                    statusIcon.innerHTML = `<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                    statusText.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                    break;
            }
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”»é¢ã«è¡¨ç¤ºã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function appendMessage(text, sender = 'ã‚·ã‚¹ãƒ†ãƒ ') {
            const p = document.createElement('p');
            p.textContent = `${sender}: ${text}`;
            messagesDiv.appendChild(p);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // æ™‚é–“ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg z-50 transition-opacity duration-300 opacity-0';
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '1';
            }, 10);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.addEventListener('transitionend', () => toast.remove());
            }, 2000);
        }

        // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('IDãŒã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸï¼');
            }).catch(err => {
                console.error('ã‚³ãƒ”ãƒ¼å¤±æ•—:', err);
                showToast('IDã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            });
        }


        // PeerJSåˆæœŸåŒ–
        function initializePeer(id = null) {
            if (AppState.peer) {
                AppState.peer.destroy();
                AppState.peer = null;
            }
            AppState.peer = new Peer(id, AppState.peerServerConfig);

            AppState.peer.on('open', (newId) => {
                AppState.myPeerId = newId;
                AppState.connectionStatus = 'disconnected'; // PeerJSã‚µãƒ¼ãƒãƒ¼ã¸ã®æ¥ç¶šã¯å®Œäº†ã—ãŸãŒã€é€šè©±ã¯ã¾ã 
                console.log('Peer ID:', newId);
                updateUI();
                // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ãƒ«ãƒ¼ãƒ ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
                fetchRooms();
            });

            AppState.peer.on('error', (err) => {
                console.error('PeerJSã‚¨ãƒ©ãƒ¼:', err);
                AppState.connectionStatus = 'error';
                appendMessage(`ã‚¨ãƒ©ãƒ¼: ${err.message || err.type}`, 'PeerJS');
                if (err.type === 'peer-unavailable') {
                    appendMessage('æŒ‡å®šã•ã‚ŒãŸPeer IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ç›¸æ‰‹ãŒã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã§ã€IDãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                } else if (err.type === 'network') {
                    appendMessage('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã®å•é¡Œã§ã™ã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã¾ãŸã¯ã‚µãƒ¼ãƒãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                } else if (err.type === 'disconnected') {
                    appendMessage('PeerJSã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰åˆ‡æ–­ã•ã‚Œã¾ã—ãŸã€‚');
                } else if (err.type === 'browser-incompatible') {
                    appendMessage('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯WebRTCã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚æœ€æ–°ã®Chrome, Firefox, Edgeãªã©ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚');
                }
                updateUI();
            });

            AppState.peer.on('close', () => {
                console.log('PeerJSæ¥ç¶šãŒé–‰ã˜ã‚‰ã‚Œã¾ã—ãŸã€‚');
                AppState.connectionStatus = 'disconnected';
                updateUI();
            });

            AppState.peer.on('disconnected', () => {
                console.log('PeerJSã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰åˆ‡æ–­ã•ã‚Œã¾ã—ãŸã€‚');
                AppState.connectionStatus = 'disconnected';
                // PeerJSã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰åˆ‡æ–­ã•ã‚ŒãŸå¾Œã€å†æ¥ç¶šã‚’è©¦ã¿ã‚‹å ´åˆ
                // setTimeout(() => initializePeer(), 5000); 
                updateUI();
            });

            // ã‚²ã‚¹ãƒˆã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿æ¥ç¶šãŒã‚ã£ãŸæ™‚ (ãƒ›ã‚¹ãƒˆå´ãŒå—ä¿¡)
            AppState.peer.on('connection', (conn) => {
                console.log(`'${conn.peer}' ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿æ¥ç¶šãŒã‚ã‚Šã¾ã—ãŸã€‚`);
                appendMessage(`'${conn.peer}' ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿æ¥ç¶šè¦æ±‚ã€‚`);
                setupDataConnectionEvents(conn);
            });

            // ã‚²ã‚¹ãƒˆã‹ã‚‰ã®ãƒ¡ãƒ‡ã‚£ã‚¢æ¥ç¶š (éŸ³å£°) ãŒã‚ã£ãŸæ™‚ (ãƒ›ã‚¹ãƒˆå´ãŒå—ä¿¡)
            AppState.peer.on('call', (call) => {
                if (!AppState.isHost) {
                    console.log('ãƒ›ã‚¹ãƒˆã§ã¯ãªã„ãŸã‚ã€ç€ä¿¡ã‚’æ‹’å¦ã—ã¾ã™ã€‚');
                    call.close();
                    appendMessage(`ã‚²ã‚¹ãƒˆã‹ã‚‰ã®æ¥ç¶šã‚’æ‹’å¦ã—ã¾ã—ãŸã€‚ã‚ãªãŸã¯ãƒ›ã‚¹ãƒˆã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚`);
                    return;
                }
                console.log(`'${call.peer}' ã‹ã‚‰ãƒ¡ãƒ‡ã‚£ã‚¢æ¥ç¶šãŒã‚ã‚Šã¾ã—ãŸã€‚`);
                appendMessage(`'${call.peer}' ã‹ã‚‰ãƒ¡ãƒ‡ã‚£ã‚¢æ¥ç¶šè¦æ±‚ã€‚`);

                if (AppState.audioStream) {
                    call.answer(AppState.audioStream);
                    AppState.currentCall = call;
                    AppState.remotePeerId = call.peer;
                    setupMediaCallEvents(call);
                    AppState.isConnected = true;
                    AppState.connectionStatus = 'connected';
                    appendMessage(`'${call.peer}' ã¨é€šè©±é–‹å§‹ã€‚`, 'ã‚·ã‚¹ãƒ†ãƒ ');
                } else {
                    console.error('ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚');
                    appendMessage('ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ãƒ›ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚');
                    call.close();
                }
                updateUI();
            });
        }

        // ãƒ‡ãƒ¼ã‚¿æ¥ç¶šã‚¤ãƒ™ãƒ³ãƒˆã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        function setupDataConnectionEvents(conn) {
            if (AppState.dataConnection) {
                AppState.dataConnection.close();
            }
            AppState.dataConnection = conn;

            conn.on('open', () => {
                console.log(`'${conn.peer}' ã¨ã®ãƒ‡ãƒ¼ã‚¿æ¥ç¶šãŒç¢ºç«‹ã•ã‚Œã¾ã—ãŸã€‚`);
                updateUI();
            });

            conn.on('data', (data) => {
                console.log(`'${conn.peer}' ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡:`, data);
                appendMessage(data, conn.peer);
            });

            conn.on('close', () => {
                console.log(`'${conn.peer}' ã¨ã®ãƒ‡ãƒ¼ã‚¿æ¥ç¶šãŒé–‰ã˜ã‚‰ã‚Œã¾ã—ãŸã€‚`);
                AppState.dataConnection = null;
                if (!AppState.currentCall || AppState.currentCall.open === false) {
                     endCall();
                }
                updateUI();
            });

            conn.on('error', (err) => {
                console.error(`'${conn.peer}' ã¨ã®ãƒ‡ãƒ¼ã‚¿æ¥ç¶šã‚¨ãƒ©ãƒ¼:`, err);
                appendMessage(`ãƒ‡ãƒ¼ã‚¿æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${err.message}`, 'æ¥ç¶š');
            });
        }

        // ãƒ¡ãƒ‡ã‚£ã‚¢é€šè©±ã‚¤ãƒ™ãƒ³ãƒˆã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        function setupMediaCallEvents(call) {
            call.on('stream', (remoteStream) => {
                console.log('ç›¸æ‰‹ã®ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’å—ä¿¡ã€‚');
                remoteAudio.srcObject = remoteStream;
                remoteAudio.play().catch(e => console.warn("Remote audio playback failed:", e));
            });

            call.on('close', () => {
                console.log('ãƒ¡ãƒ‡ã‚£ã‚¢æ¥ç¶šãŒé–‰ã˜ã‚‰ã‚Œã¾ã—ãŸã€‚');
                remoteAudio.srcObject = null;
                if (!AppState.dataConnection || AppState.dataConnection.open === false) {
                    endCall();
                }
                updateUI();
            });

            call.on('error', (err) => {
                console.error('ãƒ¡ãƒ‡ã‚£ã‚¢æ¥ç¶šã‚¨ãƒ©ãƒ¼:', err);
                appendMessage(`ãƒ¡ãƒ‡ã‚£ã‚¢æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${err.message}`, 'ãƒ¡ãƒ‡ã‚£ã‚¢');
            });
        }

        // ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆã—ã¦ãƒ›ã‚¹ãƒˆã«ãªã‚‹
        async function createRoomAndHost() {
            const roomName = roomNameInput.value.trim();
            if (!roomName) {
                showToast('ãƒ«ãƒ¼ãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼');
                return;
            }

            AppState.connectionStatus = 'connecting';
            updateUI();
            appendMessage('ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¦æ±‚ã—ã¦ã„ã¾ã™...');

            try {
                AppState.audioStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: 44100
                    }
                });

                localAudio.srcObject = AppState.audioStream;
                localAudio.play().catch(e => console.warn("Local audio playback failed:", e));

                // PeerJSåˆæœŸåŒ–ï¼ˆIDã¯è‡ªå‹•ç”Ÿæˆï¼‰
                initializePeer();

                // PeerJSãŒIDã‚’ç”Ÿæˆã—ãŸã‚‰APIã«ç™»éŒ²
                AppState.peer.on('open', async (id) => {
                    AppState.myPeerId = id; // PeerJSã«ã‚ˆã£ã¦å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸIDã‚’ä¿å­˜

                    // ãƒ«ãƒ¼ãƒ ç®¡ç†APIã«ãƒ«ãƒ¼ãƒ æƒ…å ±ã‚’ç™»éŒ²
                    try {
                        const response = await fetch(`${AppState.apiBaseUrl}/rooms`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ name: roomName, hostPeerId: AppState.myPeerId })
                        });
                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                        }
                        const roomData = await response.json();
                        AppState.currentRoomId = roomData.roomId; // ä½œæˆã•ã‚ŒãŸãƒ«ãƒ¼ãƒ ã®IDã‚’ä¿æŒ

                        AppState.isHost = true;
                        AppState.isConnected = false; // ã¾ã ã‚²ã‚¹ãƒˆã¨ã¯ç¹‹ãŒã£ã¦ã„ãªã„
                        AppState.remotePeerId = '';
                        AppState.connectionStatus = 'connected'; // PeerJSã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šæ¸ˆã¿
                        appendMessage(`ãƒ«ãƒ¼ãƒ ã€Œ${roomName}ã€ã‚’ä½œæˆã—ã€ãƒ›ã‚¹ãƒˆã¨ã—ã¦å¾…æ©Ÿä¸­ã€‚ãƒ«ãƒ¼ãƒ ID: ${AppState.currentRoomId}`);
                        startRecordingTimer();
                        updateUI();
                        showToast(`ãƒ«ãƒ¼ãƒ ã€Œ${roomName}ã€ã‚’ä½œæˆã—ã¾ã—ãŸï¼`);
                        roomNameInput.value = ''; // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
                        fetchRooms(); // ãƒ«ãƒ¼ãƒ ä¸€è¦§ã‚’æ›´æ–°ã—ã¦è‡ªåˆ†ã®ãƒ«ãƒ¼ãƒ ã‚’è¡¨ç¤º
                    } catch (apiError) {
                        console.error('ãƒ«ãƒ¼ãƒ ä½œæˆAPIã‚¨ãƒ©ãƒ¼:', apiError);
                        appendMessage(`ãƒ«ãƒ¼ãƒ ä½œæˆã‚¨ãƒ©ãƒ¼: ${apiError.message}`, 'APIã‚¨ãƒ©ãƒ¼');
                        AppState.connectionStatus = 'error';
                        updateUI();
                        // APIã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯PeerJSã‚‚ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                        if (AppState.peer) AppState.peer.destroy();
                        if (AppState.audioStream) AppState.audioStream.getTracks().forEach(track => track.stop());
                    }
                });

            } catch (error) {
                console.error('ãƒ›ã‚¹ãƒˆé–‹å§‹ã‚¨ãƒ©ãƒ¼:', error);
                AppState.connectionStatus = 'error';
                appendMessage(`ãƒ›ã‚¹ãƒˆé–‹å§‹ã‚¨ãƒ©ãƒ¼: ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„ (${error.message})`, 'ã‚¨ãƒ©ãƒ¼');
                updateUI();
            }
        }

        // ãƒ«ãƒ¼ãƒ ã«å‚åŠ ã™ã‚‹
        async function joinRoom(roomId, hostPeerId, roomName) {
            if (AppState.isConnected) {
                showToast('ã™ã§ã«é€šè©±ä¸­ã§ã™ã€‚');
                return;
            }

            AppState.connectionStatus = 'connecting';
            AppState.remotePeerId = hostPeerId; // ãƒ›ã‚¹ãƒˆã®Peer IDã«è¨­å®š
            AppState.currentRoomId = roomId; // å‚åŠ ã™ã‚‹ãƒ«ãƒ¼ãƒ ã®IDã‚’ä¿æŒ
            updateUI();
            appendMessage(`ãƒ«ãƒ¼ãƒ ã€Œ${roomName}ã€(${hostPeerId}) ã¸ã®æ¥ç¶šã‚’è©¦ã¿ã¦ã„ã¾ã™...`);
            appendMessage('ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¦æ±‚ã—ã¦ã„ã¾ã™...');

            try {
                AppState.audioStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: 44100
                    }
                });
                localAudio.srcObject = AppState.audioStream;
                localAudio.play().catch(e => console.warn("Local audio playback failed:", e));

                // PeerJSåˆæœŸåŒ– (ã‚²ã‚¹ãƒˆå´ã¯IDã‚’è‡ªå‹•ç”Ÿæˆ)
                initializePeer();

                // PeerJSãŒIDã‚’ç”Ÿæˆã—ãŸã‚‰æ¥ç¶šã‚’é–‹å§‹
                AppState.peer.on('open', () => {
                    // ãƒ‡ãƒ¼ã‚¿æ¥ç¶šã‚’é–‹å§‹
                    const dataConn = AppState.peer.connect(hostPeerId);
                    setupDataConnectionEvents(dataConn);

                    // ãƒ¡ãƒ‡ã‚£ã‚¢æ¥ç¶šï¼ˆéŸ³å£°é€šè©±ï¼‰ã‚’é–‹å§‹
                    const mediaCall = AppState.peer.call(hostPeerId, AppState.audioStream);
                    AppState.currentCall = mediaCall;
                    AppState.isHost = false; // ã‚²ã‚¹ãƒˆã¨ã—ã¦å‚åŠ 
                    AppState.isConnected = true;
                    AppState.connectionStatus = 'connected';
                    setupMediaCallEvents(mediaCall);
                    appendMessage(`ãƒ«ãƒ¼ãƒ ã€Œ${roomName}ã€ã«æ¥ç¶šã—ã¾ã—ãŸã€‚`, 'ã‚·ã‚¹ãƒ†ãƒ ');
                    updateUI();
                });

            } catch (error) {
                console.error('æ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
                AppState.connectionStatus = 'error';
                appendMessage(`æ¥ç¶šã‚¨ãƒ©ãƒ¼: ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„ (${error.message})`, 'ã‚¨ãƒ©ãƒ¼');
                updateUI();
            }
        }

        // é€šè©±çµ‚äº†
        async function endCall() {
            if (AppState.currentCall) {
                AppState.currentCall.close();
            }
            if (AppState.dataConnection) {
                AppState.dataConnection.close();
            }

            if (AppState.audioStream) {
                AppState.audioStream.getTracks().forEach(track => track.stop());
                AppState.audioStream = null;
            }

            localAudio.srcObject = null;
            remoteAudio.srcObject = null;

            if (AppState.recordingTimer) {
                clearInterval(AppState.recordingTimer);
                AppState.recordingTimer = null;
            }
            recordingTimeEl.textContent = '0:00'; // ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ


            // ãƒ›ã‚¹ãƒˆã¨ã—ã¦ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆã—ã¦ã„ãŸå ´åˆã€ãƒ«ãƒ¼ãƒ ã‚’å‰Šé™¤
            if (AppState.isHost && AppState.currentRoomId) {
                try {
                    const response = await fetch(`${AppState.apiBaseUrl}/rooms/${AppState.currentRoomId}`, {
                        method: 'DELETE'
                    });
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                    }
                    appendMessage(`ãƒ«ãƒ¼ãƒ ã€Œ${AppState.currentRoomId}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`, 'ã‚·ã‚¹ãƒ†ãƒ ');
                } catch (apiError) {
                    console.error('ãƒ«ãƒ¼ãƒ å‰Šé™¤APIã‚¨ãƒ©ãƒ¼:', apiError);
                    appendMessage(`ãƒ«ãƒ¼ãƒ å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${apiError.message}`, 'APIã‚¨ãƒ©ãƒ¼');
                }
            }

            // PeerJSã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç ´æ£„ã—ã¦å†åˆæœŸåŒ–å¯èƒ½ãªçŠ¶æ…‹ã«ã™ã‚‹
            if (AppState.peer) {
                AppState.peer.destroy();
                AppState.peer = null;
            }
            initializePeer(); // æ–°ã—ã„Peerã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã—ã€IDã‚’å†å–å¾—
            
            AppState.isConnected = false;
            AppState.isHost = false;
            AppState.remotePeerId = '';
            AppState.currentRoomId = null;
            AppState.currentCall = null;
            AppState.dataConnection = null;
            AppState.connectionStatus = 'disconnected';

            appendMessage('é€šè©±ãŒçµ‚äº†ã—ã¾ã—ãŸã€‚', 'ã‚·ã‚¹ãƒ†ãƒ ');
            updateUI();
            fetchRooms(); // ãƒ«ãƒ¼ãƒ ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
        }

        // éŒ²éŸ³ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹ (ãƒ›ã‚¹ãƒˆå´ã®ã¿)
        function startRecordingTimer() {
            AppState.recordingTime = 0;
            if (AppState.recordingTimer) clearInterval(AppState.recordingTimer);
            AppState.recordingTimer = setInterval(() => {
                AppState.recordingTime++;
                recordingTimeEl.textContent = formatTime(AppState.recordingTime);
            }, 1000);
        }

        // ãƒ«ãƒ¼ãƒ ä¸€è¦§ã‚’å–å¾—ã—ã¦è¡¨ç¤º
        async function fetchRooms() {
            roomsContainer.innerHTML = '<p class="text-gray-600 text-center">ãƒ«ãƒ¼ãƒ ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>';
            try {
                const response = await fetch(`${AppState.apiBaseUrl}/rooms`);
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }
                const rooms = await response.json();
                
                roomsContainer.innerHTML = ''; // ã‚¯ãƒªã‚¢

                if (rooms.length === 0) {
                    roomsContainer.innerHTML = '<p class="text-gray-600 text-center">ç¾åœ¨ã€ä½œæˆã•ã‚Œã¦ã„ã‚‹ãƒ«ãƒ¼ãƒ ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                } else {
                    rooms.forEach(room => {
                        const roomDiv = document.createElement('div');
                        roomDiv.className = 'flex items-center justify-between p-3 bg-white border border-gray-200 rounded-md shadow-sm';
                        roomDiv.innerHTML = `
                            <span class="font-semibold text-gray-800 text-lg">${room.name}</span>
                            <button class="join-room-button bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg text-sm transition-colors"
                                data-room-id="${room.roomId}"
                                data-host-peer-id="${room.hostPeerId}"
                                data-room-name="${room.name}">
                                å‚åŠ 
                            </button>
                        `;
                        roomsContainer.appendChild(roomDiv);
                    });

                    // å‚åŠ ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                    document.querySelectorAll('.join-room-button').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const roomId = e.target.dataset.roomId;
                            const hostPeerId = e.target.dataset.hostPeerId;
                            const roomName = e.target.dataset.roomName;
                            joinRoom(roomId, hostPeerId, roomName);
                        });
                    });
                }
            } catch (error) {
                console.error('ãƒ«ãƒ¼ãƒ ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                roomsContainer.innerHTML = `<p class="text-red-600 text-center">ãƒ«ãƒ¼ãƒ ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}</p>`;
                showToast('ãƒ«ãƒ¼ãƒ ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚APIã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
        }

        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
        createRoomButton.addEventListener('click', createRoomAndHost);
        endCallButton.addEventListener('click', endCall);
        refreshRoomsButton.addEventListener('click', fetchRooms);
        sendMessageButton.addEventListener('click', () => {
            const message = messageInput.value.trim();
            if (message && AppState.dataConnection && AppState.dataConnection.open) {
                AppState.dataConnection.send(message);
                appendMessage(message, 'ã‚ãªãŸ');
                messageInput.value = '';
            } else if (!AppState.isConnected) {
                showToast('é€šè©±ã«å‚åŠ ã—ã¦ã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¦ãã ã•ã„ã€‚');
            } else {
                showToast('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            }
        });
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessageButton.click();
            }
        });
        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«PeerJSã‚’åˆæœŸåŒ–ã—ã€ãƒ«ãƒ¼ãƒ ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
        window.addEventListener('load', () => {
            initializePeer();
        });

    </script>
</body>
</html>
