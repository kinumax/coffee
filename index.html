<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PeerJS WebRTC App</title>
    <meta name="description" content="PeerJS WebRTC Minimal App with integrated features.">

    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“</text></svg>">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <style>
        /* ã‚«ã‚¹ã‚¿ãƒ CSSã¯æœ€å°é™ã« */
        body {
            font-family: sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        #localAudio, #remoteAudio {
            display: none; /* Audio elements are typically hidden */
        }
        .peer-id-box {
            font-family: 'Courier New', monospace;
            letter-spacing: 1px;
            cursor: copy;
        }
        .recording-pulse {
            animation: pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .connection-status-message {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen">
    <div id="app" class="container bg-white">
        <h1 class="text-3xl font-bold text-center text-blue-700 mb-6 flex items-center justify-center space-x-2">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            PeerJS éŸ³å£°é€šè©±ã‚¢ãƒ—ãƒª
        </h1>

        <div id="connectionStatus" class="connection-status-message p-3 mb-4 rounded-lg text-sm flex items-center space-x-2">
            <svg id="statusIcon" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <p id="statusText">æœªæ¥ç¶š</p>
        </div>

        <div class="space-y-6">
            <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg shadow-sm text-center">
                <p class="text-blue-700 text-sm mb-2">ã‚ãªãŸã®Peer ID:</p>
                <div class="flex items-center justify-center space-x-2">
                    <span id="myPeerId" class="peer-id-box bg-blue-100 text-blue-800 px-4 py-2 rounded-md text-lg font-semibold select-all" onclick="copyToClipboard(this.textContent)">IDç”Ÿæˆä¸­...</span>
                    <button id="copyIdButton" class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-full shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                    </button>
                </div>
                <p class="text-gray-600 text-xs mt-2">ã“ã®IDã‚’ç›¸æ‰‹ã«ä¼ãˆã¦ãã ã•ã„ã€‚</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button id="hostButton" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-green-500 transition-all flex items-center justify-center space-x-2 text-lg">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg>
                    <span>ãƒ›ã‚¹ãƒˆã«ãªã‚‹</span>
                </button>

                <div class="flex flex-col space-y-2">
                    <input type="text" id="targetPeerIdInput" placeholder="ç›¸æ‰‹ã®Peer IDã‚’å…¥åŠ›" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-base">
                    <button id="connectButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all flex items-center justify-center space-x-2 text-lg">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
                        <span>ç›¸æ‰‹ã«æ¥ç¶šã™ã‚‹</span>
                    </button>
                </div>
            </div>

            <div id="callControls" class="bg-gray-50 border border-gray-200 p-4 rounded-lg shadow-sm text-center hidden">
                <p class="text-gray-700 text-sm mb-2" id="callStatusText"></p>
                <div class="flex items-center justify-center space-x-4 mb-4">
                    <div id="recordingPulse" class="w-4 h-4 bg-red-500 rounded-full recording-pulse hidden"></div>
                    <div class="text-4xl font-bold text-gray-900" id="recordingTime">0:00</div>
                </div>
                <button id="endCallButton" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-red-500 transition-all flex items-center justify-center space-x-2 text-lg w-full">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16.72 11.06A10.94 10.94 0 0119 12.55a1 1 0 01-.051 1.81l-4.494 1.498a1 1 0 01-1.21-.502l-1.13-2.257M16.72 11.06l-1.475 1.475M16.72 11.06L21 6.78m-4.28 4.28L12 6.34m3.72 4.72l-3.72-4.72m0 0L5.78 1.22 4.36 2.64l14.142 14.142 1.415-1.414L11.06 6.34z"/></svg>
                    <span>é€šè©±ã‚’çµ‚äº†</span>
                </button>
            </div>

            <div class="bg-white border border-gray-200 p-4 rounded-lg shadow-sm">
                <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">ãƒãƒ£ãƒƒãƒˆ</h2>
                <div id="messages" class="h-60 overflow-y-auto border border-gray-300 p-3 rounded-lg bg-gray-50 mb-4 text-gray-700 text-sm leading-relaxed">
                    </div>
                <div class="flex space-x-2">
                    <input type="text" id="messageInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-base">
                    <button id="sendMessageButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                        é€ä¿¡
                    </button>
                </div>
            </div>
        </div>

        <audio id="localAudio" autoplay muted></audio>
        <audio id="remoteAudio" autoplay></audio>
    </div>

    <script>
        // DOMè¦ç´ ã®å–å¾—
        const myPeerIdEl = document.getElementById('myPeerId');
        const copyIdButton = document.getElementById('copyIdButton');
        const targetPeerIdInput = document.getElementById('targetPeerIdInput');
        const hostButton = document.getElementById('hostButton');
        const connectButton = document.getElementById('connectButton');
        const endCallButton = document.getElementById('endCallButton');
        const localAudio = document.getElementById('localAudio');
        const remoteAudio = document.getElementById('remoteAudio');
        const messageInput = document.getElementById('messageInput');
        const sendMessageButton = document.getElementById('sendMessageButton');
        const messagesDiv = document.getElementById('messages');
        const callControls = document.getElementById('callControls');
        const recordingTimeEl = document.getElementById('recordingTime');
        const recordingPulseEl = document.getElementById('recordingPulse');
        const connectionStatusDiv = document.getElementById('connectionStatus');
        const statusIcon = document.getElementById('statusIcon');
        const statusText = document.getElementById('statusText');
        const callStatusText = document.getElementById('callStatusText');

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹
        const AppState = {
            peer: null,
            myPeerId: '',
            remotePeerId: '',
            isConnected: false,
            isHost: false,
            isGuest: false,
            audioStream: null,
            currentCall: null,
            dataConnection: null, // PeerJS DataConnectionç”¨
            recordingTime: 0,
            recordingTimer: null,
            // disconnected, connecting, connected, error
            connectionStatus: 'disconnected'
        };

        // PeerJSã‚µãƒ¼ãƒãƒ¼ã®è¨­å®š
        const PEER_SERVER_CONFIG = {
            host: 'localhost',
            port: 9000,
            path: '/myapp',
            config: {
                'iceServers': [
                    { 'urls': 'stun:stun.l.google.com:19302' } // NATè¶Šãˆã®ãŸã‚ã®STUNã‚µãƒ¼ãƒãƒ¼
                ]
            }
        };

        // UIæ›´æ–°é–¢æ•°
        function updateUI() {
            myPeerIdEl.textContent = AppState.myPeerId || 'IDç”Ÿæˆä¸­...';
            targetPeerIdInput.value = AppState.remotePeerId;

            hostButton.disabled = AppState.isConnected || AppState.connectionStatus === 'connecting';
            targetPeerIdInput.disabled = AppState.isConnected || AppState.connectionStatus === 'connecting';
            connectButton.disabled = AppState.isConnected || AppState.connectionStatus === 'connecting';
            sendMessageButton.disabled = !AppState.isConnected || !AppState.dataConnection || !AppState.dataConnection.open;
            messageInput.disabled = !AppState.isConnected || !AppState.dataConnection || !AppState.dataConnection.open;

            if (AppState.isConnected) {
                callControls.classList.remove('hidden');
                hostButton.classList.add('hidden');
                document.querySelector('.grid.grid-cols-1.md\\:grid-cols-2').classList.add('hidden'); // ãƒ›ã‚¹ãƒˆ/ã‚²ã‚¹ãƒˆé¸æŠã‚’éš ã™
                if (AppState.isHost) {
                    callStatusText.textContent = `ãƒ›ã‚¹ãƒˆã¨ã—ã¦ '${AppState.remotePeerId}' ã¨é€šè©±ä¸­`;
                    recordingPulseEl.classList.remove('hidden');
                } else if (AppState.isGuest) {
                    callStatusText.textContent = `'${AppState.remotePeerId}' ã¨é€šè©±ä¸­`;
                    recordingPulseEl.classList.add('hidden'); // ã‚²ã‚¹ãƒˆã¯éŒ²ç”»ãƒ‘ãƒ«ã‚¹ã‚’è¡¨ç¤ºã—ãªã„
                }
            } else {
                callControls.classList.add('hidden');
                hostButton.classList.remove('hidden');
                document.querySelector('.grid.grid-cols-1.md\\:grid-cols-2').classList.remove('hidden');
                recordingPulseEl.classList.add('hidden');
            }

            // æ¥ç¶šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®è¡¨ç¤ºæ›´æ–°
            connectionStatusDiv.className = 'connection-status-message p-3 mb-4 rounded-lg text-sm flex items-center space-x-2';
            switch (AppState.connectionStatus) {
                case 'disconnected':
                    connectionStatusDiv.classList.add('bg-blue-50', 'border-blue-200', 'text-blue-800');
                    statusIcon.innerHTML = `<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                    statusText.textContent = 'æœªæ¥ç¶š';
                    break;
                case 'connecting':
                    connectionStatusDiv.classList.add('bg-yellow-50', 'border-yellow-200', 'text-yellow-800');
                    statusIcon.innerHTML = `<svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
                    statusText.textContent = 'æ¥ç¶šä¸­...';
                    break;
                case 'connected':
                    connectionStatusDiv.classList.add('bg-green-50', 'border-green-200', 'text-green-800');
                    statusIcon.innerHTML = `<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>`;
                    statusText.textContent = `æ¥ç¶šæ¸ˆã¿${AppState.remotePeerId ? `: ${AppState.remotePeerId}` : ''}`;
                    break;
                case 'error':
                    connectionStatusDiv.classList.add('bg-red-50', 'border-red-200', 'text-red-800');
                    statusIcon.innerHTML = `<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                    statusText.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                    break;
            }
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”»é¢ã«è¡¨ç¤ºã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function appendMessage(text, sender = 'ã‚·ã‚¹ãƒ†ãƒ ') {
            const p = document.createElement('p');
            p.textContent = `${sender}: ${text}`;
            messagesDiv.appendChild(p);
            messagesDiv.scrollTop = messagesDiv.scrollHeight; // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ä¸€ç•ªä¸‹ã¸
        }

        // æ™‚é–“ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg z-50 transition-opacity duration-300 opacity-0';
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '1';
            }, 10); // çŸ­ã„é…å»¶ã§ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ã‚’æœ‰åŠ¹åŒ–

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.addEventListener('transitionend', () => toast.remove());
            }, 2000);
        }

        // PeerJSåˆæœŸåŒ–
        function initializePeer(id = null) {
            if (AppState.peer) {
                AppState.peer.destroy();
                AppState.peer = null;
            }
            AppState.peer = new Peer(id, PEER_SERVER_CONFIG);

            AppState.peer.on('open', (newId) => {
                AppState.myPeerId = newId;
                AppState.connectionStatus = 'disconnected'; // PeerJSã‚µãƒ¼ãƒãƒ¼ã¸ã®æ¥ç¶šã¯å®Œäº†ã—ãŸãŒã€P2Pæ¥ç¶šã¯æœªç¢ºç«‹
                console.log('Peer ID:', newId);
                updateUI();
            });

            AppState.peer.on('error', (err) => {
                console.error('PeerJSã‚¨ãƒ©ãƒ¼:', err);
                AppState.connectionStatus = 'error';
                appendMessage(`ã‚¨ãƒ©ãƒ¼: ${err.message || err.type}`, 'PeerJS');
                if (err.type === 'peer-unavailable') {
                    appendMessage('æŒ‡å®šã•ã‚ŒãŸPeer IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ç›¸æ‰‹ãŒã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã§ã€IDãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                } else if (err.type === 'network') {
                    appendMessage('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã®å•é¡Œã§ã™ã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã¾ãŸã¯ã‚µãƒ¼ãƒãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                } else if (err.type === 'disconnected') {
                     // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰åˆ‡æ–­ã•ã‚ŒãŸå ´åˆã¯ã€å†æ¥ç¶šã‚’ä¿ƒã™
                    appendMessage('PeerJSã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰åˆ‡æ–­ã•ã‚Œã¾ã—ãŸã€‚');
                }
                updateUI();
            });

            AppState.peer.on('close', () => {
                console.log('PeerJSæ¥ç¶šãŒé–‰ã˜ã‚‰ã‚Œã¾ã—ãŸã€‚');
                AppState.connectionStatus = 'disconnected';
                updateUI();
            });

            AppState.peer.on('disconnected', () => {
                console.log('PeerJSã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰åˆ‡æ–­ã•ã‚Œã¾ã—ãŸã€‚');
                AppState.connectionStatus = 'disconnected';
                updateUI();
                // å¿…è¦ã§ã‚ã‚Œã°ã“ã“ã§è‡ªå‹•å†æ¥ç¶šãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…
            });

            // ã‚²ã‚¹ãƒˆã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿æ¥ç¶šãŒã‚ã£ãŸæ™‚ (ãƒ›ã‚¹ãƒˆå´ãŒå—ä¿¡)
            AppState.peer.on('connection', (conn) => {
                console.log(`'${conn.peer}' ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿æ¥ç¶šãŒã‚ã‚Šã¾ã—ãŸã€‚`);
                appendMessage(`'${conn.peer}' ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿æ¥ç¶šè¦æ±‚ã€‚`);
                setupDataConnectionEvents(conn);
            });

            // ã‚²ã‚¹ãƒˆã‹ã‚‰ã®ãƒ¡ãƒ‡ã‚£ã‚¢æ¥ç¶š (éŸ³å£°) ãŒã‚ã£ãŸæ™‚ (ãƒ›ã‚¹ãƒˆå´ãŒå—ä¿¡)
            AppState.peer.on('call', (call) => {
                if (!AppState.isHost) {
                    console.log('ãƒ›ã‚¹ãƒˆã§ã¯ãªã„ãŸã‚ã€ç€ä¿¡ã‚’æ‹’å¦ã—ã¾ã™ã€‚');
                    call.close();
                    appendMessage(`ã‚²ã‚¹ãƒˆã‹ã‚‰ã®æ¥ç¶šã‚’æ‹’å¦ã—ã¾ã—ãŸã€‚ã‚ãªãŸã¯ãƒ›ã‚¹ãƒˆã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚`);
                    return;
                }
                console.log(`'${call.peer}' ã‹ã‚‰ãƒ¡ãƒ‡ã‚£ã‚¢æ¥ç¶šãŒã‚ã‚Šã¾ã—ãŸã€‚`);
                appendMessage(`'${call.peer}' ã‹ã‚‰ãƒ¡ãƒ‡ã‚£ã‚¢æ¥ç¶šè¦æ±‚ã€‚`);

                if (AppState.audioStream) {
                    call.answer(AppState.audioStream); // è‡ªåˆ†ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’é€ä¿¡ã—ã¦å¿œç­”
                    AppState.currentCall = call; // ç¾åœ¨ã®é€šè©±ã‚’ä¿æŒ
                    AppState.remotePeerId = call.peer;
                    setupMediaCallEvents(call);
                    AppState.isConnected = true;
                    AppState.connectionStatus = 'connected';
                    appendMessage(`'${call.peer}' ã¨é€šè©±é–‹å§‹ã€‚`, 'ã‚·ã‚¹ãƒ†ãƒ ');
                } else {
                    console.error('ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚');
                    appendMessage('ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ãƒ›ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚');
                    call.close();
                }
                updateUI();
            });
        }

        // ãƒ‡ãƒ¼ã‚¿æ¥ç¶šã‚¤ãƒ™ãƒ³ãƒˆã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        function setupDataConnectionEvents(conn) {
            // æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿æ¥ç¶šãŒã‚ã‚Œã°ã‚¯ãƒ­ãƒ¼ã‚º
            if (AppState.dataConnection) {
                AppState.dataConnection.close();
            }
            AppState.dataConnection = conn;

            conn.on('open', () => {
                console.log(`'${conn.peer}' ã¨ã®ãƒ‡ãƒ¼ã‚¿æ¥ç¶šãŒç¢ºç«‹ã•ã‚Œã¾ã—ãŸã€‚`);
                // ãƒ‡ãƒ¼ã‚¿æ¥ç¶šç¢ºç«‹å¾Œã€UIã‚’æ›´æ–°
                updateUI();
            });

            conn.on('data', (data) => {
                console.log(`'${conn.peer}' ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡:`, data);
                appendMessage(data, conn.peer);
            });

            conn.on('close', () => {
                console.log(`'${conn.peer}' ã¨ã®ãƒ‡ãƒ¼ã‚¿æ¥ç¶šãŒé–‰ã˜ã‚‰ã‚Œã¾ã—ãŸã€‚`);
                AppState.dataConnection = null;
                // ãƒ‡ãƒ¼ã‚¿æ¥ç¶šãŒé–‰ã˜ã‚‰ã‚Œã¦ã‚‚ã€ãƒ¡ãƒ‡ã‚£ã‚¢æ¥ç¶šãŒç¶šã„ã¦ã„ã‚‹å ´åˆãŒã‚ã‚‹
                if (!AppState.currentCall || AppState.currentCall.open === false) {
                     endCall(); // ä¸¡æ–¹é–‰ã˜ã¦ã„ã‚Œã°å®Œå…¨çµ‚äº†
                }
                updateUI();
            });

            conn.on('error', (err) => {
                console.error(`'${conn.peer}' ã¨ã®ãƒ‡ãƒ¼ã‚¿æ¥ç¶šã‚¨ãƒ©ãƒ¼:`, err);
                appendMessage(`ãƒ‡ãƒ¼ã‚¿æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${err.message}`, 'æ¥ç¶š');
            });
        }

        // ãƒ¡ãƒ‡ã‚£ã‚¢é€šè©±ã‚¤ãƒ™ãƒ³ãƒˆã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        function setupMediaCallEvents(call) {
            call.on('stream', (remoteStream) => {
                console.log('ç›¸æ‰‹ã®ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’å—ä¿¡ã€‚');
                remoteAudio.srcObject = remoteStream; // ç›¸æ‰‹ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’å†ç”Ÿ
                remoteAudio.play().catch(e => console.warn("Remote audio playback failed:", e));
            });

            call.on('close', () => {
                console.log('ãƒ¡ãƒ‡ã‚£ã‚¢æ¥ç¶šãŒé–‰ã˜ã‚‰ã‚Œã¾ã—ãŸã€‚');
                remoteAudio.srcObject = null;
                // ãƒ¡ãƒ‡ã‚£ã‚¢æ¥ç¶šãŒé–‰ã˜ã‚‰ã‚Œã¦ã‚‚ã€ãƒ‡ãƒ¼ã‚¿æ¥ç¶šãŒç¶šã„ã¦ã„ã‚‹å ´åˆãŒã‚ã‚‹
                if (!AppState.dataConnection || AppState.dataConnection.open === false) {
                    endCall(); // ä¸¡æ–¹é–‰ã˜ã¦ã„ã‚Œã°å®Œå…¨çµ‚äº†
                }
                updateUI();
            });

            call.on('error', (err) => {
                console.error('ãƒ¡ãƒ‡ã‚£ã‚¢æ¥ç¶šã‚¨ãƒ©ãƒ¼:', err);
                appendMessage(`ãƒ¡ãƒ‡ã‚£ã‚¢æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${err.message}`, 'ãƒ¡ãƒ‡ã‚£ã‚¢');
            });
        }

        // ãƒ›ã‚¹ãƒˆã«ãªã‚‹
        async function startHosting() {
            try {
                AppState.connectionStatus = 'connecting';
                updateUI();
                appendMessage('ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¦æ±‚ã—ã¦ã„ã¾ã™...');

                AppState.audioStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: 44100
                    }
                });

                localAudio.srcObject = AppState.audioStream; // è‡ªåˆ†ã®éŸ³å£°ã‚’ãƒ¢ãƒ‹ã‚¿ãƒ¼ï¼ˆmutedï¼‰
                localAudio.play().catch(e => console.warn("Local audio playback failed:", e));

                initializePeer(); // IDã‚’è‡ªå‹•ç”Ÿæˆã•ã›ã‚‹

                AppState.peer.on('open', (id) => {
                    AppState.isHost = true;
                    AppState.isConnected = false; // ã¾ã ã‚²ã‚¹ãƒˆã¨ã¯ç¹‹ãŒã£ã¦ã„ãªã„
                    AppState.remotePeerId = '';
                    AppState.connectionStatus = 'connected'; // PeerJSã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šæ¸ˆã¿
                    appendMessage(`ãƒ›ã‚¹ãƒˆã¨ã—ã¦å¾…æ©Ÿä¸­ã€‚ã‚ãªãŸã®ID: ${id}`);
                    startRecordingTimer();
                    updateUI();
                });

            } catch (error) {
                console.error('ãƒ›ã‚¹ãƒˆé–‹å§‹ã‚¨ãƒ©ãƒ¼:', error);
                AppState.connectionStatus = 'error';
                appendMessage(`ãƒ›ã‚¹ãƒˆé–‹å§‹ã‚¨ãƒ©ãƒ¼: ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„ (${error.message})`, 'ã‚¨ãƒ©ãƒ¼');
                updateUI();
            }
        }

        // ç›¸æ‰‹ã«æ¥ç¶šã™ã‚‹
        async function connectToHost() {
            const targetPeerId = targetPeerIdInput.value.trim();
            if (!targetPeerId) {
                showToast('ç›¸æ‰‹ã®Peer IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼');
                return;
            }

            AppState.connectionStatus = 'connecting';
            AppState.remotePeerId = targetPeerId;
            updateUI();
            appendMessage(`'${targetPeerId}' ã¸ã®æ¥ç¶šã‚’è©¦ã¿ã¦ã„ã¾ã™...`);
            appendMessage('ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¦æ±‚ã—ã¦ã„ã¾ã™...');

            try {
                AppState.audioStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: 44100
                    }
                });
                localAudio.srcObject = AppState.audioStream; // è‡ªåˆ†ã®éŸ³å£°ã‚’ãƒ¢ãƒ‹ã‚¿ãƒ¼ï¼ˆmutedï¼‰
                localAudio.play().catch(e => console.warn("Local audio playback failed:", e));

                // ãƒ›ã‚¹ãƒˆå´ã¨ã¯ç•°ãªã‚Šã€æ¥ç¶šå´ã¯IDã‚’è‡ªå‹•ç”Ÿæˆã—ã¦åˆæœŸåŒ–
                initializePeer();

                AppState.peer.on('open', () => {
                    // ãƒ‡ãƒ¼ã‚¿æ¥ç¶šã‚’é–‹å§‹
                    const dataConn = AppState.peer.connect(targetPeerId);
                    setupDataConnectionEvents(dataConn);

                    // ãƒ¡ãƒ‡ã‚£ã‚¢æ¥ç¶šï¼ˆéŸ³å£°é€šè©±ï¼‰ã‚’é–‹å§‹
                    const mediaCall = AppState.peer.call(targetPeerId, AppState.audioStream);
                    AppState.currentCall = mediaCall; // ç¾åœ¨ã®é€šè©±ã‚’ä¿æŒ
                    AppState.isGuest = true;
                    AppState.isConnected = true;
                    AppState.connectionStatus = 'connected';
                    setupMediaCallEvents(mediaCall); // MediaConnectionã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
                    appendMessage(`'${targetPeerId}' ã«æ¥ç¶šã—ã¾ã—ãŸã€‚`, 'ã‚·ã‚¹ãƒ†ãƒ ');
                    updateUI();
                });

            } catch (error) {
                console.error('æ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
                AppState.connectionStatus = 'error';
                appendMessage(`æ¥ç¶šã‚¨ãƒ©ãƒ¼: ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„ (${error.message})`, 'ã‚¨ãƒ©ãƒ¼');
                updateUI();
            }
        }

        // é€šè©±çµ‚äº†
        function endCall() {
            if (AppState.currentCall) {
                AppState.currentCall.close();
            }
            if (AppState.dataConnection) {
                AppState.dataConnection.close();
            }

            if (AppState.audioStream) {
                AppState.audioStream.getTracks().forEach(track => track.stop());
                AppState.audioStream = null;
            }

            localAudio.srcObject = null;
            remoteAudio.srcObject = null;

            if (AppState.recordingTimer) {
                clearInterval(AppState.recordingTimer);
                AppState.recordingTimer = null;
            }

            AppState.isConnected = false;
            AppState.isHost = false;
            AppState.isGuest = false;
            AppState.remotePeerId = '';
            AppState.currentCall = null;
            AppState.dataConnection = null;
            AppState.connectionStatus = 'disconnected';

            appendMessage('é€šè©±ãŒçµ‚äº†ã—ã¾ã—ãŸã€‚', 'ã‚·ã‚¹ãƒ†ãƒ ');
            updateUI();
        }

        // éŒ²éŸ³ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹ (ãƒ›ã‚¹ãƒˆå´ã®ã¿)
        function startRecordingTimer() {
            AppState.recordingTime = 0;
            if (AppState.recordingTimer) clearInterval(AppState.recordingTimer); // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ãŒã‚ã‚Œã°ã‚¯ãƒªã‚¢
            AppState.recordingTimer = setInterval(() => {
                AppState.recordingTime++;
                recordingTimeEl.textContent = formatTime(AppState.recordingTime);
            }, 1000);
        }

        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
        hostButton.addEventListener('click', startHosting);
        connectButton.addEventListener('click', connectToHost);
        endCallButton.addEventListener('click', endCall);

        sendMessageButton.addEventListener('click', () => {
            if (AppState.dataConnection && AppState.dataConnection.open) {
                const message = messageInput.value.trim();
                if (message) {
                    AppState.dataConnection.send(message);
                    appendMessage(message, 'ã‚ãªãŸ');
                    messageInput.value = '';
                }
            } else {
                showToast('ãƒãƒ£ãƒƒãƒˆæ¥ç¶šãŒç¢ºç«‹ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
            }
        });

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessageButton.click();
            }
        });

        copyIdButton.addEventListener('click', () => {
            copyToClipboard(myPeerIdEl.textContent);
        });

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«PeerJSã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’åˆæœŸåŒ–ï¼ˆIDã¯å¾Œã§è‡ªå‹•ç”Ÿæˆã¾ãŸã¯æŒ‡å®šï¼‰
        // PeerJSã‚µãƒ¼ãƒãƒ¼ã¸ã®æ¥ç¶šè‡ªä½“ã¯æœ€åˆã«è¡Œã†
        initializePeer();
        updateUI(); // åˆæœŸUIè¡¨ç¤º

        // åˆå›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        appendMessage('ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šè©±ã‚’é–‹å§‹ã™ã‚‹ã«ã¯ã€ã€Œãƒ›ã‚¹ãƒˆã«ãªã‚‹ã€ã‹ã€ç›¸æ‰‹ã®IDã‚’å…¥åŠ›ã—ã¦ã€Œç›¸æ‰‹ã«æ¥ç¶šã™ã‚‹ã€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'ã‚·ã‚¹ãƒ†ãƒ ');

    </script>
</body>
</html>
