<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coffee配信</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', sans-serif; background: linear-gradient(135deg, #6B4E3D, #8B5A3C); min-height: 100vh; color: white; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .status-bar { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center; }
        .controls { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.3s; }
        .btn-primary { background: #D2691E; color: white; }
        .btn-primary:hover { background: #B8860B; transform: translateY(-2px); }
        .btn-secondary { background: rgba(255,255,255,0.2); color: white; }
        .btn-secondary:hover { background: rgba(255,255,255,0.3); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .video-container { position: relative; margin-bottom: 20px; }
        .video { width: 100%; height: 300px; background: #000; border-radius: 10px; object-fit: cover; }
        .rooms-list { background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .room-item { background: rgba(255,255,255,0.1); padding: 15px; margin: 10px 0; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .viewer-count { background: #D2691E; padding: 5px 10px; border-radius: 15px; font-size: 14px; }
        .chat-container { background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; height: 300px; display: flex; flex-direction: column; }
        .chat-messages { flex: 1; overflow-y: auto; margin-bottom: 10px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 5px; }
        .chat-input-container { display: flex; gap: 10px; }
        .chat-input { flex: 1; padding: 10px; border: none; border-radius: 5px; background: rgba(255,255,255,0.9); }
        .message { margin-bottom: 10px; padding: 8px; background: rgba(255,255,255,0.1); border-radius: 5px; }
        .message-time { font-size: 12px; opacity: 0.7; }
        .hidden { display: none; }
        .loading { text-align: center; padding: 20px; }
        @media (max-width: 600px) {
            .container { padding: 10px; }
            .controls { flex-direction: column; }
            .btn { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>☕ Coffee配信</h1>
            <div class="status-bar">
                <span id="connectionStatus">接続中...</span>
                <span id="onlineCount" class="viewer-count">0人オンライン</span>
            </div>
        </div>

        <!-- メイン画面 -->
        <div id="mainScreen">
            <div class="controls">
                <button class="btn btn-primary" onclick="startStreaming()">配信開始</button>
                <button class="btn btn-secondary" onclick="showRoomsList()">ルーム一覧</button>
                <input type="text" placeholder="ルーム名を入力" id="roomNameInput" style="padding: 12px; border-radius: 8px; border: none;">
            </div>
        </div>

        <!-- 配信画面 -->
        <div id="streamingScreen" class="hidden">
            <div class="video-container">
                <video id="localVideo" class="video" autoplay muted playsinline></video>
            </div>
            <div class="controls">
                <button class="btn btn-secondary" onclick="stopStreaming()">配信終了</button>
                <span id="viewerCount" class="viewer-count">0人視聴中</span>
            </div>
        </div>

        <!-- ルーム一覧 -->
        <div id="roomsScreen" class="hidden">
            <div class="rooms-list">
                <h3>アクティブなルーム</h3>
                <div id="roomsList"></div>
            </div>
            <div class="controls">
                <button class="btn btn-secondary" onclick="showMainScreen()">戻る</button>
                <button class="btn btn-primary" onclick="refreshRooms()">更新</button>
            </div>
        </div>

        <!-- 視聴画面 -->
        <div id="viewingScreen" class="hidden">
            <div class="video-container">
                <video id="remoteVideo" class="video" autoplay playsinline></video>
            </div>
            <div class="controls">
                <button class="btn btn-secondary" onclick="leaveRoom()">退出</button>
                <span id="currentRoomName">ルーム名</span>
            </div>
        </div>

        <!-- チャット -->
        <div class="chat-container">
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input-container">
                <input type="text" class="chat-input" id="chatInput" placeholder="メッセージを入力...">
                <button class="btn btn-primary" onclick="sendMessage()">送信</button>
            </div>
        </div>
    </div>

    <script>
        // グローバル変数
        let ws = null;
        let localStream = null;
        let remoteStream = null;
        let peerConnection = null;
        let currentRoom = null;
        let isStreaming = false;
        let userId = generateUserId();

        // WebSocket接続とリアルタイム通信
        function connectWebSocket() {
            // 本来はWebSocketサーバーが必要ですが、簡易版としてServer-Sent Eventsを使用
            // 実際の実装では専用のWebSocketサーバーを構築してください
            
            // 擬似的なリアルタイム通信（実際にはFirebaseやSupabaseのリアルタイム機能を推奨）
            console.log('WebSocket接続を試行中...');
            
            // 定期的にルーム一覧を更新
            setInterval(updateRoomsList, 3000);
            setInterval(updateOnlineCount, 5000);
            
            document.getElementById('connectionStatus').textContent = '接続済み';
        }

        // ユーザーID生成
        function generateUserId() {
            return 'user_' + Math.random().toString(36).substr(2, 9);
        }

        // 配信開始
        async function startStreaming() {
            const roomName = document.getElementById('roomNameInput').value.trim();
            if (!roomName) {
                alert('ルーム名を入力してください');
                return;
            }

            try {
                // カメラとマイクにアクセス
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'user'
                    },
                    audio: true
                });

                document.getElementById('localVideo').srcObject = localStream;
                
                // ルーム作成
                currentRoom = {
                    id: generateRoomId(),
                    name: roomName,
                    creator: userId,
                    createdAt: new Date().toISOString(),
                    viewers: 0
                };

                // ローカルストレージとクラウドストレージの両方に保存
                saveRoomToStorage(currentRoom);
                
                isStreaming = true;
                showStreamingScreen();
                
                // WebRTC接続の準備
                setupPeerConnection();
                
                console.log('配信開始:', currentRoom);
                
            } catch (error) {
                console.error('配信開始エラー:', error);
                alert('カメラまたはマイクにアクセスできませんでした');
            }
        }

        // WebRTC接続設定
        function setupPeerConnection() {
            const configuration = {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            };

            peerConnection = new RTCPeerConnection(configuration);

            // ローカルストリームを追加
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
            }

            // リモートストリーム受信
            peerConnection.ontrack = (event) => {
                remoteStream = event.streams[0];
                document.getElementById('remoteVideo').srcObject = remoteStream;
            };

            // ICE候補の処理
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    // 実際の実装ではシグナリングサーバーに送信
                    console.log('ICE candidate:', event.candidate);
                }
            };
        }

        // ルームID生成
        function generateRoomId() {
            return 'room_' + Math.random().toString(36).substr(2, 9);
        }

        // ルームをストレージに保存
        function saveRoomToStorage(room) {
            const rooms = getRoomsFromStorage();
            rooms[room.id] = room;
            localStorage.setItem('coffee_rooms', JSON.stringify(rooms));
            
            // 実際の実装では外部データベース（Firebase/Supabase）に保存
            saveRoomToCloud(room);
        }

        // クラウドストレージに保存（擬似実装）
        function saveRoomToCloud(room) {
            // 実際にはFirebase Firestore、Supabase、または独自APIを使用
            fetch('/api/rooms', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(room)
            }).catch(error => {
                console.log('クラウド保存失敗（開発環境では正常）:', error);
            });
        }

        // ローカルストレージからルーム取得
        function getRoomsFromStorage() {
            const stored = localStorage.getItem('coffee_rooms');
            return stored ? JSON.parse(stored) : {};
        }

        // 配信終了
        function stopStreaming() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }

            // ルーム削除
            if (currentRoom) {
                deleteRoomFromStorage(currentRoom.id);
                currentRoom = null;
            }

            isStreaming = false;
            showMainScreen();
        }

        // ルームをストレージから削除
        function deleteRoomFromStorage(roomId) {
            const rooms = getRoomsFromStorage();
            delete rooms[roomId];
            localStorage.setItem('coffee_rooms', JSON.stringify(rooms));
            
            // クラウドからも削除
            fetch(`/api/rooms/${roomId}`, {
                method: 'DELETE'
            }).catch(error => {
                console.log('クラウド削除失敗（開発環境では正常）:', error);
            });
        }

        // ルーム一覧更新
        function updateRoomsList() {
            const rooms = getRoomsFromStorage();
            const roomsList = document.getElementById('roomsList');
            
            if (Object.keys(rooms).length === 0) {
                roomsList.innerHTML = '<p>現在アクティブなルームはありません</p>';
                return;
            }

            roomsList.innerHTML = '';
            Object.values(rooms).forEach(room => {
                const roomElement = document.createElement('div');
                roomElement.className = 'room-item';
                roomElement.innerHTML = `
                    <div>
                        <strong>${room.name}</strong>
                        <div class="message-time">${new Date(room.createdAt).toLocaleTimeString()}</div>
                    </div>
                    <div>
                        <span class="viewer-count">${room.viewers || 0}人</span>
                        <button class="btn btn-primary" onclick="joinRoom('${room.id}')" style="margin-left: 10px;">参加</button>
                    </div>
                `;
                roomsList.appendChild(roomElement);
            });
        }

        // ルーム参加
        async function joinRoom(roomId) {
            const rooms = getRoomsFromStorage();
            const room = rooms[roomId];
            
            if (!room) {
                alert('ルームが見つかりません');
                return;
            }

            try {
                // 視聴者用の接続設定
                setupPeerConnection();
                
                currentRoom = room;
                document.getElementById('currentRoomName').textContent = room.name;
                
                // 視聴者カウント更新
                room.viewers = (room.viewers || 0) + 1;
                saveRoomToStorage(room);
                
                showViewingScreen();
                
                console.log('ルーム参加:', room);
                
            } catch (error) {
                console.error('ルーム参加エラー:', error);
                alert('ルームに参加できませんでした');
            }
        }

        // ルーム退出
        function leaveRoom() {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }

            if (currentRoom) {
                // 視聴者カウント減少
                const rooms = getRoomsFromStorage();
                if (rooms[currentRoom.id]) {
                    rooms[currentRoom.id].viewers = Math.max(0, (rooms[currentRoom.id].viewers || 1) - 1);
                    saveRoomToStorage(rooms[currentRoom.id]);
                }
                currentRoom = null;
            }

            showMainScreen();
        }

        // チャット機能
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;

            const messageObj = {
                id: Date.now(),
                userId: userId,
                message: message,
                timestamp: new Date().toISOString(),
                roomId: currentRoom?.id
            };

            displayMessage(messageObj);
            saveMessageToStorage(messageObj);
            input.value = '';
        }

        // メッセージ表示
        function displayMessage(messageObj) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageElement = document.createElement('div');
            messageElement.className = 'message';
            messageElement.innerHTML = `
                <div><strong>ユーザー${messageObj.userId.slice(-4)}</strong></div>
                <div>${messageObj.message}</div>
                <div class="message-time">${new Date(messageObj.timestamp).toLocaleTimeString()}</div>
            `;
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // メッセージ保存
        function saveMessageToStorage(messageObj) {
            const messages = getMessagesFromStorage();
            messages.push(messageObj);
            
            // 最新100件のみ保持
            if (messages.length > 100) {
                messages.splice(0, messages.length - 100);
            }
            
            localStorage.setItem('coffee_messages', JSON.stringify(messages));
        }

        // メッセージ取得
        function getMessagesFromStorage() {
            const stored = localStorage.getItem('coffee_messages');
            return stored ? JSON.parse(stored) : [];
        }

        // オンラインユーザー数更新
        function updateOnlineCount() {
            // 実際の実装では外部サービスから取得
            const count = Math.floor(Math.random() * 20) + 1;
            document.getElementById('onlineCount').textContent = `${count}人オンライン`;
        }

        // 画面表示制御
        function showMainScreen() {
            hideAllScreens();
            document.getElementById('mainScreen').classList.remove('hidden');
        }

        function showStreamingScreen() {
            hideAllScreens();
            document.getElementById('streamingScreen').classList.remove('hidden');
        }

        function showRoomsList() {
            hideAllScreens();
            document.getElementById('roomsScreen').classList.remove('hidden');
            updateRoomsList();
        }

        function showViewingScreen() {
            hideAllScreens();
            document.getElementById('viewingScreen').classList.remove('hidden');
        }

        function hideAllScreens() {
            document.querySelectorAll('#mainScreen, #streamingScreen, #roomsScreen, #viewingScreen')
                .forEach(screen => screen.classList.add('hidden'));
        }

        function refreshRooms() {
            updateRoomsList();
        }

        // イベントリスナー
        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            connectWebSocket();
            
            // 既存のメッセージを表示
            const messages = getMessagesFromStorage();
            messages.slice(-20).forEach(displayMessage);
        });

        // ページ離脱時のクリーンアップ
        window.addEventListener('beforeunload', function() {
            if (isStreaming) {
                stopStreaming();
            } else if (currentRoom) {
                leaveRoom();
            }
        });
    </script>
</body>
</html>
