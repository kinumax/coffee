<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coffee - 音声配信アプリ</title>
    <meta name="description" content="Coffeeは音声配信プラットフォームです。お気に入りの番組を聴いたり、自分で配信したりできます。">
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>☕</text></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        coffee: {
                            50: '#fdf8f0',
                            100: '#fbeee0',
                            200: '#f6d6b3',
                            300: '#f0c185',
                            400: '#e8a852',
                            500: '#d2691e',
                            600: '#b8651e',
                            700: '#9e5a1a',
                            800: '#844e16',
                            900: '#6a4113',
                            950: '#3d1f07'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes pulse-recording {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .recording-pulse {
            animation: pulse-recording 1s ease-in-out infinite;
        }
        .wave-animation {
            animation: wave 2s ease-in-out infinite;
        }
        @keyframes wave {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(1.5); }
        }
        .live-indicator {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .peer-id-box {
            font-family: 'Courier New', monospace;
            letter-spacing: 1px;
        }
        .connection-status {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="min-h-screen transition-colors duration-300">
    <div id="app" class="max-w-md mx-auto min-h-screen relative"></div>

    <script>
        // アプリの状態管理
        const AppState = {
            currentTab: 'home',
            isPlaying: false,
            isRecording: false,
            isLive: false,
            currentShow: null,
            searchQuery: '',
            recordingTime: 0,
            recordingTimer: null,
            isDarkMode: false,
            userId: null,
            userName: '',
            
            // P2P関連
            peer: null,
            myPeerId: '',
            remotePeerId: '',
            isConnected: false,
            isHost: false,
            isGuest: false,
            audioStream: null,
            currentCall: null,
            connectionStatus: 'disconnected', // disconnected, connecting, connected, error
            
            // ローカルサンプルデータ
            sampleShows: [
                {
                    id: 'sample-1',
                    title: "朝のコーヒーブレイク",
                    host: "田中さくら",
                    listeners: 1234,
                    duration: "12:34",
                    category: "ライフスタイル",
                    isLive: false,
                    avatar: "☕",
                    likes: 89,
                    comments: 23,
                    isLocal: true
                },
                {
                    id: 'sample-2',
                    title: "深夜の読書会",
                    host: "山田太郎",
                    listeners: 567,
                    duration: "25:16",
                    category: "読書",
                    isLive: false,
                    avatar: "📚",
                    likes: 156,
                    comments: 34,
                    isLocal: true
                }
            ],
            
            categories: ["すべて", "ライフスタイル", "読書", "ニュース", "音楽", "トーク", "学習"]
        };

        // アイコンSVGの定義
        const Icons = {
            Home: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11v11a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>',
            Plus: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>',
            User: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>',
            Play: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>',
            Pause: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
            Mic: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg>',
            Search: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>',
            Heart: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>',
            MessageCircle: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>',
            Volume2: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M11 5L6 9H2v6h4l5 4V5z"/></svg>',
            Coffee: '<svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-8a2 2 0 00-2 2v2m12 0H4m12 0l1.5 8.5a1.5 1.5 0 01-1.5 1.5H8a1.5 1.5 0 01-1.5-1.5L8 6m4 0V4m0 0h4m-4 0H8"/></svg>',
            Moon: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>',
            Sun: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg>',
            Radio: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.348 14.651a3.75 3.75 0 010-5.303m5.304 0a3.75 3.75 0 010 5.303m-7.425 2.122a7.5 7.5 0 010-10.607m9.546 0a7.5 7.5 0 010 10.607M12 12h.01"/></svg>',
            Phone: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>',
            PhoneOff: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16.72 11.06A10.94 10.94 0 0119 12.55a1 1 0 01-.051 1.81l-4.494 1.498a1 1 0 01-1.21-.502l-1.13-2.257M16.72 11.06l-1.475 1.475M16.72 11.06L21 6.78m-4.28 4.28L12 6.34m3.72 4.72l-3.72-4.72m0 0L5.78 1.22 4.36 2.64l14.142 14.142 1.415-1.414L11.06 6.34z"/></svg>',
            Copy: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>',
            Check: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>'
        };

        // P2P関連の関数
        async function initializePeer() {
            try {
                // ユーザーIDの生成
                AppState.userId = 'user_' + Math.random().toString(36).substr(2, 9);
                AppState.userName = 'ユーザー' + Math.random().toString(36).substr(2, 4);
                
                // PeerJS初期化
                AppState.peer = new Peer(AppState.userId, {
                    debug: 2,
                    config: {
                        'iceServers': [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' }
                        ]
                    }
                });
                
                AppState.peer.on('open', (id) => {
                    AppState.myPeerId = id;
                    AppState.connectionStatus = 'disconnected';
                    console.log('Peer ID:', id);
                    render();
                });
                
                AppState.peer.on('call', (call) => {
                    handleIncomingCall(call);
                });
                
                AppState.peer.on('error', (error) => {
                    console.error('Peer error:', error);
                    AppState.connectionStatus = 'error';
                    render();
                });
                
                AppState.peer.on('disconnected', () => {
                    AppState.connectionStatus = 'disconnected';
                    render();
                });
                
            } catch (error) {
                console.error('Peer initialization error:', error);
                AppState.connectionStatus = 'error';
                render();
            }
        }

        async function startHosting() {
            try {
                AppState.connectionStatus = 'connecting';
                render();
                
                AppState.audioStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: 44100
                    } 
                });
                
                AppState.isHost = true;
                AppState.isLive = true;
                AppState.isRecording = true;
                AppState.recordingTime = 0;
                
                AppState.recordingTimer = setInterval(() => {
                    AppState.recordingTime++;
                    updateRecordingTime();
                }, 1000);
                
                AppState.connectionStatus = 'connected';
                console.log('ホスト準備完了、ゲストの接続を待機中...');
                render();
                
            } catch (error) {
                console.error('ホスト開始エラー:', error);
                AppState.connectionStatus = 'error';
                alert('マイクへのアクセスが必要です。ブラウザの設定を確認してください。');
                render();
            }
        }

        async function connectToHost(hostId) {
            try {
                if (!hostId.trim()) {
                    alert('ホストIDを入力してください');
                    return;
                }
                
                AppState.connectionStatus = 'connecting';
                AppState.remotePeerId = hostId.trim();
                render();
                
                const audioStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: 44100
                    } 
                });
                
                const call = AppState.peer.call(hostId, audioStream);
                
                call.on('stream', (remoteStream) => {
                    playRemoteAudio(remoteStream);
                    AppState.isConnected = true;
                    AppState.isGuest = true;
                    AppState.currentCall = call;
                    AppState.connectionStatus = 'connected';
                    console.log('ホストに接続完了');
                    render();
                });
                
                call.on('close', () => {
                    AppState.isConnected = false;
                    AppState.connectionStatus = 'disconnected';
                    console.log('通話終了');
                    render();
                });
                
                call.on('error', (error) => {
                    console.error('通話エラー:', error);
                    AppState.connectionStatus = 'error';
                    render();
                });
                
            } catch (error) {
                console.error('接続エラー:', error);
                AppState.connectionStatus = 'error';
                alert('マイクへのアクセスが必要です。ブラウザの設定を確認してください。');
                render();
            }
        }

        async function handleIncomingCall(call) {
            try {
                if (!AppState.isHost) {
                    call.close();
                    return;
                }
                
                console.log('ゲストからの通話を受信:', call.peer);
                
                const audioStream = AppState.audioStream;
                call.answer(audioStream);
                
                call.on('stream', (remoteStream) => {
                    playRemoteAudio(remoteStream);
                    AppState.isConnected = true;
                    AppState.currentCall = call;
                    AppState.remotePeerId = call.peer;
                    console.log('ゲストとの通話開始');
                    render();
                });
                
                call.on('close', () => {
                    AppState.isConnected = false;
                    AppState.remotePeerId = '';
                    console.log('ゲストが切断');
                    render();
                });
                
                call.on('error', (error) => {
                    console.error('通話エラー:', error);
                    render();
                });
                
            } catch (error) {
                console.error('着信処理エラー:', error);
            }
        }

        function playRemoteAudio(stream) {
            const audio = document.createElement('audio');
            audio.srcObject = stream;
            audio.autoplay = true;
            audio.playsInline = true;
            document.body.appendChild(audio); // DOMに追加して再生
            // For iOS compatibility, try playing it immediately on user interaction
            audio.play().catch(e => console.warn("Audio playback failed, likely due to autoplay policy:", e));
        }

        function endCall() {
            if (AppState.currentCall) {
                AppState.currentCall.close();
            }
            
            if (AppState.audioStream) {
                AppState.audioStream.getTracks().forEach(track => track.stop());
                AppState.audioStream = null;
            }
            
            // Remove all dynamically added audio elements
            document.querySelectorAll('audio').forEach(audio => audio.remove());

            if (AppState.recordingTimer) {
                clearInterval(AppState.recordingTimer);
                AppState.recordingTimer = null;
            }
            
            AppState.isConnected = false;
            AppState.isHost = false;
            AppState.isGuest = false;
            AppState.isLive = false;
            AppState.isRecording = false;
            AppState.recordingTime = 0;
            AppState.remotePeerId = '';
            AppState.currentCall = null;
            AppState.connectionStatus = 'disconnected';
            
            console.log('通話終了');
            render();
        }

        // ユーティリティ関数
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return mins + ':' + secs.toString().padStart(2, '0');
        }

        function formatNumber(num) {
            return num.toLocaleString();
        }

        function createIcon(iconName, className = '') {
            const icon = Icons[iconName];
            if (!icon) return '';
            if (className) {
                return icon.replace('class="', `class="${className} `);
            }
            return icon;
        }

        function updateBodyClass() {
            const body = document.body;
            if (AppState.isDarkMode) {
                body.className = 'bg-coffee-950 text-white min-h-screen transition-colors duration-300';
            } else {
                body.className = 'bg-gradient-to-b from-amber-50 to-orange-50 min-h-screen transition-colors duration-300';
            }
        }

        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                showToast('IDをコピーしました');
            } catch (error) {
                console.error('クリップボードコピーエラー:', error);
                showToast('コピーに失敗しました');
            }
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg z-50 transition-opacity duration-300';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 2000);
        }

        // イベントハンドラー
        function handleTabChange(tab) {
            AppState.currentTab = tab;
            render();
        }

        function handlePlay(showId) {
            const show = AppState.sampleShows.find(s => s.id === showId);
            if (!show) return;
            
            // サンプル番組の再生/停止
            if (AppState.currentShow && AppState.currentShow.id === show.id) {
                AppState.isPlaying = !AppState.isPlaying;
            } else {
                AppState.currentShow = show;
                AppState.isPlaying = true;
            }
            render();
        }

        function handleSearch(query) {
            AppState.searchQuery = query;
            render();
        }

        function handleLike(showId) {
            const show = AppState.sampleShows.find(s => s.id === showId);
            if (show) {
                show.likes++;
            }
            render();
        }

        function handleDarkModeToggle() {
            AppState.isDarkMode = !AppState.isDarkMode;
            updateBodyClass();
            render();
        }

        function updateRecordingTime() {
            const timeElement = document.getElementById('recording-time');
            if (timeElement) {
                timeElement.textContent = formatTime(AppState.recordingTime);
            }
        }

        // コンポーネント生成関数
        function createShowCard(show) {
            // 検索フィルタリング
            if (AppState.searchQuery) {
                const query = AppState.searchQuery.toLowerCase();
                const matches = show.title.toLowerCase().includes(query) ||
                               show.host.toLowerCase().includes(query) ||
                               show.category.toLowerCase().includes(query);
                if (!matches) return '';
            }

            const playButtonIcon = (AppState.currentShow && AppState.currentShow.id === show.id && AppState.isPlaying)
                ? createIcon('Pause')
                : createIcon('Play');

            const cardBg = AppState.isDarkMode ? 'bg-black border-gray-700' : 'bg-white border-amber-100';
            const titleColor = AppState.isDarkMode ? 'text-white' : 'text-gray-800';
            const hostColor = AppState.isDarkMode ? 'text-gray-300' : 'text-gray-600';
            const statsColor = AppState.isDarkMode ? 'text-gray-400' : 'text-gray-500';
            const avatarBg = AppState.isDarkMode ? 'bg-gray-800' : 'bg-amber-100';
            const categoryBg = AppState.isDarkMode ? 'bg-gray-700 text-gray-200' : 'bg-amber-50 text-amber-600';

            return `
                <div class="${cardBg} rounded-lg shadow-sm border p-3 mb-3 hover:shadow-md transition-shadow">
                    <div class="flex items-start space-x-3">
                        <div class="w-10 h-10 ${avatarBg} rounded-full flex items-center justify-center text-lg">
                            ${show.avatar}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center space-x-2 mb-1">
                                <span class="text-xs ${categoryBg} px-2 py-0.5 rounded-full">
                                    ${show.category}
                                </span>
                            </div>
                            <h3 class="font-medium ${titleColor} mb-1 text-sm leading-tight">${show.title}</h3>
                            <p class="text-xs ${hostColor} mb-2">by ${show.host}</p>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3 text-xs ${statsColor}">
                                    <span class="flex items-center space-x-1">
                                        ${createIcon('Volume2')}
                                        <span>${formatNumber(show.listeners || 0)}</span>
                                    </span>
                                    ${show.duration ? `<span>${show.duration}</span>` : ''}
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button onclick="handleLike('${show.id}')" class="text-gray-400 hover:text-red-500 transition-colors flex items-center space-x-1">
                                        ${createIcon('Heart')}
                                        <span class="text-xs">${show.likes || 0}</span>
                                    </button>
                                    <button onclick="handlePlay('${show.id}')" class="bg-amber-500 hover:bg-amber-600 text-white p-2 rounded-full transition-colors">
                                        ${playButtonIcon}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function createConnectionPanel() {
            const panelBg = AppState.isDarkMode ? 'bg-black border-gray-700' : 'bg-white border-amber-100';
            const titleColor = AppState.isDarkMode ? 'text-white' : 'text-gray-800';
            const textColor = AppState.isDarkMode ? 'text-gray-300' : 'text-gray-600';
            const inputBg = AppState.isDarkMode ? 'bg-gray-800 border-gray-600 text-white placeholder-gray-400' : 'bg-white border-gray-300';
            const buttonPrimary = 'bg-coffee-500 hover:bg-coffee-600 text-white';
            const buttonDanger = 'bg-red-500 hover:bg-red-600 text-white';

            let statusSection = '';
            
            if (AppState.connectionStatus === 'connecting') {
                statusSection = `
                    <div class="bg-yellow-50 ${AppState.isDarkMode ? 'bg-yellow-900 border-yellow-700 text-yellow-200' : 'border-yellow-200 text-yellow-800'} rounded-lg p-3 mb-4 flex items-center space-x-2 connection-status">
                        <svg class="animate-spin h-5 w-5 ${AppState.isDarkMode ? 'text-yellow-200' : 'text-yellow-500'}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="text-sm">接続中...</p>
                    </div>
                `;
            } else if (AppState.connectionStatus === 'connected') {
                statusSection = `
                    <div class="bg-green-50 ${AppState.isDarkMode ? 'bg-green-900 border-green-700 text-green-200' : 'border-green-200 text-green-800'} rounded-lg p-3 mb-4 flex items-center space-x-2 connection-status">
                        ${createIcon('Check', 'h-5 w-5 text-green-500')}
                        <p class="text-sm">接続済み: ${AppState.remotePeerId ? `<strong>${AppState.remotePeerId}</strong> と通話中` : 'ゲストを待機中'}</p>
                    </div>
                `;
            } else if (AppState.connectionStatus === 'error') {
                statusSection = `
                    <div class="bg-red-50 ${AppState.isDarkMode ? 'bg-red-900 border-red-700 text-red-200' : 'border-red-200 text-red-800'} rounded-lg p-3 mb-4 flex items-center space-x-2 connection-status">
                        <svg class="h-5 w-5 ${AppState.isDarkMode ? 'text-red-200' : 'text-red-500'}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <p class="text-sm">エラーが発生しました。ページをリロードしてください。</p>
                    </div>
                `;
            } else if (AppState.connectionStatus === 'disconnected') {
                 statusSection = `
                    <div class="bg-blue-50 ${AppState.isDarkMode ? 'bg-blue-900 border-blue-700 text-blue-200' : 'border-blue-200 text-blue-800'} rounded-lg p-3 mb-4 flex items-center space-x-2 connection-status">
                        <svg class="h-5 w-5 ${AppState.isDarkMode ? 'text-blue-200' : 'text-blue-500'}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <p class="text-sm">未接続</p>
                    </div>
                `;
            }


            let content = '';

            if (AppState.isConnected) {
                content = `
                    <div class="text-center mb-4">
                        <p class="${textColor} text-sm mb-2">通話中</p>
                        <div class="flex items-center justify-center space-x-4">
                            ${AppState.isRecording ? `<div class="w-4 h-4 bg-red-500 rounded-full recording-pulse"></div>` : ''}
                            <div class="text-3xl font-bold ${titleColor}" id="recording-time">${formatTime(AppState.recordingTime)}</div>
                        </div>
                    </div>
                    <button onclick="endCall()" class="w-full ${buttonDanger} flex items-center justify-center py-3 rounded-full text-lg font-semibold shadow-md hover:shadow-lg transition-all space-x-2">
                        ${createIcon('PhoneOff', 'w-6 h-6')}
                        <span>通話終了</span>
                    </button>
                `;
            } else {
                content = `
                    <p class="${textColor} text-sm mb-4">
                        ホストになるか、既存のホストIDに接続してリアルタイム通話を開始できます。
                    </p>

                    <div class="flex justify-between items-center mb-4">
                        <p class="${textColor} text-sm">あなたのID:</p>
                        <div class="flex items-center space-x-2">
                            <span id="my-peer-id" class="peer-id-box ${titleColor} text-sm bg-gray-100 ${AppState.isDarkMode ? 'bg-gray-800 text-gray-200' : ''} px-3 py-1 rounded-md cursor-copy" onclick="copyToClipboard(this.textContent)">
                                ${AppState.myPeerId || 'IDを生成中...'}
                            </span>
                            <button onclick="copyToClipboard(document.getElementById('my-peer-id').textContent)" class="${AppState.isDarkMode ? 'text-gray-400 hover:text-white' : 'text-gray-500 hover:text-gray-700'}">
                                ${createIcon('Copy')}
                            </button>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label for="host-id-input" class="block text-sm font-medium ${textColor} mb-2">ホストIDに接続:</label>
                            <div class="flex space-x-2">
                                <input type="text" id="host-id-input" placeholder="ホストIDを入力" class="flex-1 p-3 rounded-xl ${inputBg} focus:outline-none focus:ring-2 focus:ring-coffee-500 text-base">
                                <button onclick="connectToHost(document.getElementById('host-id-input').value)" class="flex-shrink-0 ${buttonPrimary} px-5 py-3 rounded-xl font-semibold shadow-md hover:shadow-lg transition-all text-base">
                                    接続
                                </button>
                            </div>
                        </div>
                        <div class="text-center relative">
                            <span class="${textColor} text-sm bg-transparent px-2 relative z-10">または</span>
                            <div class="absolute inset-y-0 left-0 w-full flex items-center">
                                <div class="border-t border-gray-200 ${AppState.isDarkMode ? 'border-gray-700' : ''} w-full"></div>
                            </div>
                        </div>
                        <button onclick="startHosting()" class="w-full ${buttonPrimary} flex items-center justify-center py-3 rounded-xl text-lg font-semibold shadow-md hover:shadow-lg transition-all space-x-2">
                            ${createIcon('Mic', 'w-6 h-6')}
                            <span>ホストを開始</span>
                        </button>
                    </div>
                `;
            }

            return `
                <div class="${panelBg} rounded-xl shadow-lg p-5 mb-6">
                    <h2 class="text-xl font-bold ${titleColor} mb-4 text-center">リアルタイム通話</h2>
                    ${statusSection}
                    ${content}
                </div>
            `;
        }

        function createHeader() {
            const bgColor = AppState.isDarkMode ? 'bg-black' : 'bg-white';
            const textColor = AppState.isDarkMode ? 'text-white' : 'text-gray-800';
            const iconColor = AppState.isDarkMode ? 'text-coffee-300' : 'text-coffee-500';

            return `
                <header class="sticky top-0 z-10 ${bgColor} p-4 shadow-sm ${AppState.isDarkMode ? 'border-b border-gray-700' : 'border-b border-amber-100'}">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center space-x-2">
                            ${createIcon('Coffee', `w-7 h-7 ${iconColor}`)}
                            <h1 class="text-2xl font-bold ${textColor}">Coffee</h1>
                        </div>
                        <button onclick="handleDarkModeToggle()" class="${textColor} p-2 rounded-full hover:${AppState.isDarkMode ? 'bg-gray-800' : 'bg-gray-100'} transition-colors">
                            ${AppState.isDarkMode ? createIcon('Sun') : createIcon('Moon')}
                        </button>
                    </div>
                </header>
            `;
        }

        function createSearchBar() {
            const bgColor = AppState.isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-300';
            const textColor = AppState.isDarkMode ? 'text-white' : 'text-gray-800';
            const placeholderColor = AppState.isDarkMode ? 'placeholder-gray-400' : 'placeholder-gray-500';

            return `
                <div class="p-4 ${AppState.isDarkMode ? 'bg-coffee-950' : 'bg-transparent'}">
                    <div class="relative">
                        <input type="text" id="search-input" placeholder="番組や配信者を探す" value="${AppState.searchQuery}"
                            class="w-full py-2 pl-10 pr-4 rounded-full ${bgColor} ${textColor} ${placeholderColor} focus:outline-none focus:ring-2 focus:ring-coffee-500"
                            oninput="handleSearch(this.value)">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">
                            ${createIcon('Search')}
                        </span>
                    </div>
                </div>
            `;
        }

        function createCategoryFilter() {
            const buttonBase = 'px-3 py-1 rounded-full text-sm font-medium';
            const activeBg = AppState.isDarkMode ? 'bg-coffee-600 text-white' : 'bg-coffee-500 text-white';
            const inactiveBg = AppState.isDarkMode ? 'bg-gray-800 text-gray-300' : 'bg-gray-100 text-gray-600';
            const inactiveHover = AppState.isDarkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-200';

            return `
                <div class="px-4 pb-4 overflow-x-auto whitespace-nowrap hide-scroll-bar ${AppState.isDarkMode ? 'bg-coffee-950' : 'bg-transparent'}">
                    <div class="inline-flex space-x-2">
                        ${AppState.categories.map(category => `
                            <button class="${buttonBase} ${AppState.searchQuery === category ? activeBg : inactiveBg} ${inactiveHover}"
                                onclick="handleSearch('${category === 'すべて' ? '' : category}')">
                                ${category}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function createMainContent() {
            if (AppState.currentTab === 'home') {
                return `
                    ${createSearchBar()}
                    ${createCategoryFilter()}
                    <div class="p-4 pt-0">
                        <h2 class="text-xl font-bold ${AppState.isDarkMode ? 'text-white' : 'text-gray-800'} mb-4">人気の番組</h2>
                        ${AppState.sampleShows.map(show => createShowCard(show)).join('')}
                    </div>
                `;
            } else if (AppState.currentTab === 'create') {
                return `
                    <div class="p-4">
                        ${createConnectionPanel()}
                    </div>
                `;
            } else if (AppState.currentTab === 'profile') {
                const textColor = AppState.isDarkMode ? 'text-gray-300' : 'text-gray-600';
                const titleColor = AppState.isDarkMode ? 'text-white' : 'text-gray-800';
                const cardBg = AppState.isDarkMode ? 'bg-black border-gray-700' : 'bg-white border-amber-100';
                return `
                    <div class="p-4">
                        <div class="${cardBg} rounded-xl shadow-lg p-5 text-center mb-6">
                            <div class="w-24 h-24 rounded-full ${AppState.isDarkMode ? 'bg-gray-800' : 'bg-amber-100'} flex items-center justify-center text-5xl mx-auto mb-4">
                                ${createIcon('User', 'w-12 h-12')}
                            </div>
                            <h2 class="text-2xl font-bold ${titleColor} mb-2">${AppState.userName}</h2>
                            <p class="${textColor} text-sm">あなたのID: ${AppState.userId}</p>
                        </div>
                        <div class="${cardBg} rounded-xl shadow-lg p-5">
                            <h3 class="text-lg font-bold ${titleColor} mb-4">アプリ情報</h3>
                            <ul class="space-y-2 ${textColor}">
                                <li class="flex justify-between items-center">
                                    <span>バージョン</span>
                                    <span class="font-medium">1.0.0</span>
                                </li>
                                <li class="flex justify-between items-center">
                                    <span>開発者</span>
                                    <span class="font-medium">Coffee Dev Team</span>
                                </li>
                                <li class="flex justify-between items-center">
                                    <span>プライバシーポリシー</span>
                                    <a href="#" class="text-coffee-500 hover:underline">表示</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                `;
            }
            return '';
        }

        function createNowPlayingBar() {
            if (!AppState.currentShow || !AppState.isPlaying) return '';

            const bgColor = AppState.isDarkMode ? 'bg-coffee-800 border-gray-700' : 'bg-coffee-100 border-amber-100';
            const textColor = AppState.isDarkMode ? 'text-white' : 'text-gray-800';
            const hostColor = AppState.isDarkMode ? 'text-gray-300' : 'text-gray-600';

            return `
                <div class="fixed bottom-16 left-0 right-0 max-w-md mx-auto z-20 p-4">
                    <div class="flex items-center justify-between ${bgColor} rounded-xl shadow-xl p-3 border">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 ${AppState.isDarkMode ? 'bg-gray-700' : 'bg-amber-200'} rounded-lg flex items-center justify-center text-xl">
                                ${AppState.currentShow.avatar}
                            </div>
                            <div>
                                <p class="font-medium ${textColor} text-sm">${AppState.currentShow.title}</p>
                                <p class="${hostColor} text-xs">${AppState.currentShow.host}</p>
                            </div>
                        </div>
                        <button onclick="handlePlay('${AppState.currentShow.id}')" class="bg-coffee-500 hover:bg-coffee-600 text-white p-2 rounded-full transition-colors">
                            ${createIcon('Pause')}
                        </button>
                    </div>
                </div>
            `;
        }

        function createNavBar() {
            const navItems = [
                { id: 'home', label: 'ホーム', icon: 'Home' },
                { id: 'create', label: '通話', icon: 'Radio' },
                { id: 'profile', label: 'マイページ', icon: 'User' }
            ];

            const navBg = AppState.isDarkMode ? 'bg-black' : 'bg-white';
            const activeColor = AppState.isDarkMode ? 'text-coffee-300' : 'text-coffee-500';
            const inactiveColor = AppState.isDarkMode ? 'text-gray-500' : 'text-gray-400';
            const activeBorder = AppState.isDarkMode ? 'border-coffee-500' : 'border-coffee-500';

            return `
                <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto ${navBg} border-t ${AppState.isDarkMode ? 'border-gray-700' : 'border-gray-200'} p-3 z-30">
                    <ul class="flex justify-around">
                        ${navItems.map(item => `
                            <li>
                                <button onclick="handleTabChange('${item.id}')"
                                    class="flex flex-col items-center p-2 rounded-lg transition-colors
                                    ${AppState.currentTab === item.id ? activeColor : inactiveColor}
                                    ${AppState.currentTab === item.id ? 'font-bold' : ''}
                                    hover:${AppState.isDarkMode ? 'bg-gray-800' : 'bg-gray-50'}">
                                    ${createIcon(item.icon)}
                                    <span class="text-xs mt-1">${item.label}</span>
                                </button>
                            </li>
                        `).join('')}
                    </ul>
                </nav>
            `;
        }

        // 全体をレンダリングする関数
        function render() {
            const app = document.getElementById('app');
            if (!app) return;

            updateBodyClass(); // テーマの適用

            app.innerHTML = `
                ${createHeader()}
                <main class="flex-1 overflow-y-auto pb-20">
                    ${createMainContent()}
                </main>
                ${createNowPlayingBar()}
                ${createNavBar()}
            `;

            // 必要に応じて、レンダリング後に特定の要素のイベントリスナーを再設定する
            // （ここではoninputやonclickがHTMLに直接記述されているため不要だが、複雑な場合は必要）
        }

        // アプリ起動時の初期化
        document.addEventListener('DOMContentLoaded', () => {
            initializePeer();
            render();
        });
    </script>
</body>
</html>
